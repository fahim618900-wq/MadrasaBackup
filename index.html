<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Madrasa Manager</title>

<meta name="theme-color" content="#003d3d" id="theme-color-meta">

<link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;600&display=swap" rel="stylesheet">
<link rel="stylesheet"
href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Hind Siliguri';}

body{background:#003d3d;display:flex;justify-content:center;}

.app{
max-width:412px;
width:100%;
background:#f1f1f1;
min-height:100vh;
padding-bottom:80px;
}

.page{display:none;padding:12px;}
.page.active{display:block;}

select,input{
width:100%;
padding:8px;
margin:6px 0;
border-radius:6px;
border:1px solid #ccc;
}

table{
width:100%;
border-collapse:collapse;
background:white;
font-size:14px;
}

th,td{
border:1px solid #ddd;
padding:6px;
text-align:left;
}

th{background:#004d40;color:white;}

.profile{
background:white;
padding:10px;
border-radius:10px;
}

img{
width:100px;
border-radius:8px;
margin-bottom:10px;
}

/* NAV */
nav.bottom-nav{
position:fixed;
bottom:0;
left:-5mm;
width:calc(100% + 10mm);
height:66px;
background:#fff;
display:flex;
justify-content:space-around;
align-items:center;
}

.nav-item{
text-align:center;
font-size:12px;
color:#666;
text-decoration:none;
}

.nav-item.active{color:#004d40;}
</style>
</head>

<body>

<div class="app">

<!-- ================= VIEW ================= -->
<div id="view" class="page active">

<h3>View Students</h3>

<select id="classFilter"></select>

<table>
<thead>
<tr>
<th>ID</th>
<th>Name</th>
<th>Class</th>
<th>Mobile</th>
<th>Profile</th>
</tr>
</thead>
<tbody id="studentTable"></tbody>
</table>

</div>

<!-- ================= UNPAID ================= -->
<div id="unpaid" class="page">
<h3>Monthly Unpaid</h3>
<div id="unpaidData"></div>
</div>

<!-- ================= PAID ================= -->
<div id="paid" class="page">
<h3>Monthly Paid</h3>
<div id="paidData"></div>
</div>

<!-- ================= PROFILE ================= -->
<div id="profile" class="page">
<div id="profileBox"></div>
</div>

</div>

<nav class="bottom-nav">

<a href="#" class="nav-item active" data="view">Students</a>
<a href="#" class="nav-item" data="unpaid">Unpaid</a>
<a href="#" class="nav-item" data="paid">Paid</a>

</nav>

<script>
let db;
const PASSWORD="20HikMah25";

/* ---------- NAV ---------- */
document.querySelectorAll(".nav-item").forEach(n=>{
n.onclick=e=>{
e.preventDefault();

let page=n.dataset.data;

if(page!="view"){
let p=prompt("Password Required");
if(p!==PASSWORD)return;
}

document.querySelectorAll(".nav-item")
.forEach(i=>i.classList.remove("active"));
n.classList.add("active");

document.querySelectorAll(".page")
.forEach(p=>p.classList.remove("active"));

document.getElementById(page).classList.add("active");

if(page=="paid")loadPaid();
if(page=="unpaid")loadUnpaid();
};
});

/* ---------- LOAD DB ---------- */
(async()=>{
const SQL=await initSqlJs({
locateFile:f=>"https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/"+f
});

let res=await fetch("madrasa.db");
let buf=await res.arrayBuffer();
db=new SQL.Database(new Uint8Array(buf));

initStudents();
})();

/* ---------- INIT STUDENTS ---------- */
function initStudents(){

let data=db.exec("SELECT * FROM students")[0];
let classes=[...new Set(data.values.map(v=>v[4]))];

let sel=document.getElementById("classFilter");
sel.innerHTML="<option>All Class</option>";

classes.forEach(c=>{
sel.innerHTML+=`<option>${c}</option>`;
});

renderStudents();

sel.onchange=renderStudents;
}

/* ---------- VIEW TABLE ---------- */
function renderStudents(){

let cls=document.getElementById("classFilter").value;

let q="SELECT student_id,name,class,mobile,image FROM students";

let res=db.exec(q)[0].values;

let tbody=document.getElementById("studentTable");
tbody.innerHTML="";

res.forEach(r=>{

if(cls!="All Class" && r[2]!=cls)return;

tbody.innerHTML+=`
<tr>
<td>${r[0]}</td>
<td>${r[1]}</td>
<td>${r[2]}</td>
<td>${r[3]}</td>
<td><button onclick="profile('${r[0]}')">View</button></td>
</tr>`;
});
}

/* ---------- PROFILE ---------- */
function profile(id){

let r=db.exec(
`SELECT * FROM students WHERE student_id='${id}'`
)[0].values[0];

let img="";
if(r[6]){
let blob=new Uint8Array(r[6]);
let base64=btoa(
blob.reduce((d,b)=>d+String.fromCharCode(b),'')
);
img=`<img src="data:image/jpeg;base64,${base64}">`;
}

document.getElementById("profileBox").innerHTML=`
<div class="profile">
${img}
<h3>${r[1]}</h3>
Father: ${r[2]}<br>
Class: ${r[4]}<br>
Mobile: ${r[5]}
</div>`;

showPage("profile");
}

function showPage(p){
document.querySelectorAll(".page")
.forEach(x=>x.classList.remove("active"));
document.getElementById(p).classList.add("active");
}

/* ---------- PAID ---------- */
function loadPaid(){

let res=db.exec(`
SELECT student_name,month,year,receipt_no
FROM payments
`);

let html="<table><tr><th>Name</th><th>Month</th><th>Receipt</th></tr>";

res[0].values.forEach(r=>{
html+=`
<tr>
<td>${r[0]}</td>
<td>${r[1]}/${r[2]}</td>
<td><button onclick="receipt('${r[3]}')">View</button></td>
</tr>`;
});

html+="</table>";

document.getElementById("paidData").innerHTML=html;
}

/* ---------- UNPAID ---------- */
function loadUnpaid(){

let students=db.exec(
"SELECT student_id,name,class FROM students"
)[0].values;

let paid=db.exec(
"SELECT DISTINCT student_id FROM payments"
)[0].values.map(v=>v[0]);

let html="<table><tr><th>Name</th><th>Class</th></tr>";

students.forEach(s=>{
if(!paid.includes(s[0])){
html+=`
<tr>
<td>${s[1]}</td>
<td>${s[2]}</td>
</tr>`;
}
});

html+="</table>";

document.getElementById("unpaidData").innerHTML=html;
}

/* ---------- RECEIPT ---------- */
function receipt(no){

let r=db.exec(
`SELECT * FROM payments WHERE receipt_no='${no}'`
)[0].values[0];

alert(
"Receipt: "+r[6]+
"\nName: "+r[2]+
"\nMonth: "+r[7]+"/"+r[8]+
"\nTotal: "+
(r[3]+r[4]+r[5])
);
}
</script>

</body>
</html>
