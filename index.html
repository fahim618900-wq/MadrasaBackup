<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Madrasa Student Submit</title>

<link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Hind Siliguri';}
body{background:#003d3d;display:flex;justify-content:center;padding:10px;}
.app{width:100%;max-width:412px;background:#f4f4f4;min-height:100vh;padding-bottom:20px;}
.search-box{position:sticky;top:0;background:white;padding:12px;z-index:100;box-shadow:0 2px 6px rgba(0,0,0,.2);}
select,input{width:100%;padding:10px;margin-top:6px;border-radius:6px;border:1px solid #ccc;}
table{width:100%;border-collapse:collapse;background:white;margin-top:10px;}
th,td{border:1px solid #ddd;padding:8px;font-size:14px;}
th{background:#004d40;color:white;}
tr:hover{background:#e0f2f1;cursor:pointer;}
.profile{background:white;margin:10px;padding:15px;border-radius:10px;border:2px solid #004d40;}
img{width:120px;display:block;margin:auto;margin-bottom:10px;border-radius:8px;}
button{width:100%;padding:10px;background:#004d40;color:white;border:none;border-radius:6px;margin-top:10px;cursor:pointer;}
</style>
</head>

<body>
<div class="app">

<div class="search-box">
<select id="classSelect"></select>
<input id="searchInput" placeholder="‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶õ‡¶æ‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®">
</div>

<div id="tableArea"></div>
<div id="profileArea"></div>

</div>

<script>
let db;
(async()=>{
const SQL = await initSqlJs({locateFile:f=>"https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/"+f});
let res = await fetch("madrasa.db");
let buf = await res.arrayBuffer();
db = new SQL.Database(new Uint8Array(buf));
initClasses();
})();

function initClasses(){
let data = db.exec("SELECT DISTINCT class FROM students")[0].values;
let sel = document.getElementById("classSelect");
sel.innerHTML = "<option value=''>‡¶∏‡¶¨ ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏</option>";
data.forEach(c => { sel.innerHTML += `<option>${c[0]}</option>`; });
}

// SEARCH HANDLER
document.getElementById("searchInput").oninput = function(){
let name = this.value.toLowerCase();
let cls = document.getElementById("classSelect").value.toLowerCase();
if(!name){ document.getElementById("tableArea").innerHTML=""; return; }

let rows = db.exec("SELECT student_id,name,father_name,address,class,mobile,image FROM students")[0].values;

let match = rows.filter(r=>{
let rowClass = r[4] ? r[4].toString().toLowerCase() : '';
let nameMatch = r[1] ? r[1].toLowerCase().includes(name) : false;
return (cls==="" || rowClass===cls) && nameMatch;
});
renderTable(match);
};

function renderTable(data){
if(!data.length){ document.getElementById("tableArea").innerHTML="<p style='padding:10px'>‡¶ï‡ßã‡¶®‡ßã ‡¶Æ‡¶ø‡¶≤ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø</p>"; return; }
let html="<table><tr><th>ID</th><th>Name</th><th>Father</th><th>Class</th><th>Mobile</th></tr>";
data.forEach(r=>{
html+=`<tr onclick="showProfile('${r[0]}')"><td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[4]}</td><td>${r[5]}</td></tr>`;
});
html+="</table>";
document.getElementById("tableArea").innerHTML=html;
document.getElementById("profileArea").innerHTML="";
}

function showProfile(id){
let r = db.exec(`SELECT * FROM students WHERE student_id='${id}'`)[0].values[0];
let img="";
if(r[6]){
let blob = new Uint8Array(r[6]);
let base64 = btoa(blob.reduce((d,b)=>d+String.fromCharCode(b),''));
img = `<img src="data:image/jpeg;base64,${base64}" id="profileImage">`;
}
document.getElementById("profileArea").innerHTML=`
<div class="profile" id="receiptBox">
<h3 style="text-align:center">Student Profile</h3>
${img}
<input id="name" value="${r[1]}">
<input id="father" value="${r[2]}">
<input id="address" value="${r[3]}">
<input id="cls" value="${r[4]}">
<input id="mobile" value="${r[5]}">
<button onclick="submitWhatsApp('${r[0]}')">‚úÖ Submit to WhatsApp</button>
<button onclick="downloadPDF()">üî• Download PDF</button>
</div>`;
window.scrollTo({top:500,behavior:"smooth"});
}

function submitWhatsApp(student_id){
let student = {
student_id,
name: document.getElementById("name").value,
father: document.getElementById("father").value,
address: document.getElementById("address").value,
cls: document.getElementById("cls").value,
mobile: document.getElementById("mobile").value,
imageBase64: document.getElementById("profileImage") ? document.getElementById("profileImage").src.split(",")[1] : null
};

fetch("http://localhost:3000/submit-student",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify(student)
})
.then(r=>r.json())
.then(d=>alert("Sent to WhatsApp ‚úÖ"))
.catch(e=>alert("Error sending WhatsApp: "+e));
}

function downloadPDF(){
html2pdf().set({
margin:5,filename:"Student_Profile.pdf",html2canvas:{scale:2},jsPDF:{unit:'mm',format:'a4'}
}).from(document.getElementById("receiptBox")).save();
}
</script>
</body>
</html>
